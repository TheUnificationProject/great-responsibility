name: CD

on:
  push:
    branches: [main, chore/cd]

jobs:
  prepare:
    name: Prepare dependencies
    runs-on: self-hosted
    steps:
      - name: Pull & migrate optimus-package
        working-directory: ~/the-unification-project/optimus-package
        run: |
          git pull origin main
          npm ci --omit=dev
          npm run drizzle:migrate

  deploy:
    name: Deploy
    needs: prepare
    runs-on: self-hosted
    permissions:
      contents: read

    steps:
      - name: Pull great-responsibility
        working-directory: ~/the-unification-project/great-responsibility
        run: git pull origin main

      - name: Restart great-responsibility
        working-directory: ~/the-unification-project
        run: docker compose up great-responsibility --build -d

      - name: Verify deployment
        working-directory: ~/the-unification-project
        run: |
          echo "Waiting for service to start..."
          if ! timeout 60 bash -c 'until curl -f http://localhost:3000/health; do sleep 2; done'; then
            echo "Health check failed!"
            exit 1
          fi
